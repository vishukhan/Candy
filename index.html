<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Candy Saga - Final Pro Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<style>
  :root { --gold: #feca57; --nav-bg: #1e272e; --teddy-bg: rgba(255, 215, 0, 0.4); }
  
  body { margin: 0; padding: 0; height: 100vh; background: #121212; font-family: sans-serif; color: white; overflow: hidden; touch-action: none; }
  
  #game-wrapper { 
    width: 100%; max-width: 450px; height: 100vh; position: relative; 
    background: #000; margin: auto; display: flex; flex-direction: column; 
  }

  /* Screens */
  .screen { 
    position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 75px); 
    display: none; flex-direction: column; z-index: 10;
  }
  .active-screen { display: flex; }

  /* HOME SCREEN BACKGROUND ADDED */
  #home-screen { 
    background: url('home.jpg') center/cover no-repeat; 
    justify-content: center; 
    align-items: center;
  }

  #map-screen { overflow-y: scroll; z-index: 20; background: url('map.jpg') center/cover; }
  
  #game-screen { 
    background: url('game.jpg') center/cover; 
    z-index: 5000; height: 100%; 
  }

  /* BOARD CENTERED */
  #board-container { 
    flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%;
    margin-top: -30px; 
  }

  #board { 
    position: relative; width: 320px; height: 320px; 
    border: 6px solid rgba(255,255,255,0.2); border-radius: 15px; 
    background: rgba(0,0,0,0.7); box-shadow: 0 0 40px rgba(0,0,0,0.8);
    transition: transform 0.3s ease;
  }

  /* Animations */
  @keyframes hintPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); filter: brightness(1.5); } }
  .hint-active { animation: hintPulse 0.6s infinite; z-index: 100; }
  
  @keyframes boardShake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(3deg); } 75% { transform: rotate(-3deg); } }
  .shuffling { animation: boardShake 0.15s infinite; }

  /* Elements */
  .jelly-cell { position: absolute; width: 40px; height: 40px; border: 0.1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; }
  .has-teddy { background: var(--teddy-bg); box-shadow: inset 0 0 15px gold; border-radius: 8px; }
  .candy { position: absolute; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 28px; transition: all 0.2s ease; z-index: 5; pointer-events: none; }

  /* UI & Nav */
  #mission-bar { background: rgba(0,0,0,0.85); padding: 15px; display: flex; justify-content: space-around; align-items: center; width: 100%; box-sizing: border-box; border-bottom: 2px solid var(--gold); }
  .btn { padding: 12px 40px; border-radius: 30px; border: none; font-weight: bold; background: var(--gold); color: #000; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
  #nav-bar { position: absolute; bottom: 0; width: 100%; height: 75px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; z-index: 6000; border-top: 1px solid #333; }
  .nav-tab { text-align: center; color: #888; font-size: 0.8rem; cursor: pointer; flex: 1; }
  .nav-tab.active { color: var(--gold); font-weight: bold; }

  /* Overlays */
  .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 7000; text-align: center; }
</style>
</head>
<body onclick="unlockAudio()">

<div id="game-wrapper">
  <div style="position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-around; z-index: 4000; pointer-events: none;">
    <div style="background:rgba(0,0,0,0.8); padding:5px 20px; border-radius:20px; border:1px solid var(--gold); font-weight:bold;">‚ù§Ô∏è <span id="lifeVal">5</span></div>
    <div style="background:rgba(0,0,0,0.8); padding:5px 20px; border-radius:20px; border:1px solid var(--gold); font-weight:bold;">ü™ô <span id="coinBal">0</span></div>
  </div>

  <div id="home-screen" class="screen active-screen">
    <h1 style="color:var(--gold); font-size:3.2rem; text-shadow: 4px 4px #000; margin-bottom: 30px; text-align: center;">CANDY SAGA</h1>
    <button class="btn" onclick="switchTab('map')">PLAY GAME</button>
  </div>

  <div id="map-screen" class="screen">
    <div class="map-path" id="levelPath" style="display: flex; flex-direction: column-reverse; align-items: center; gap: 70px; padding: 100px 0; min-height: 2000px;"></div>
  </div>

  <div id="daily-screen" class="screen" style="justify-content: center; align-items: center; background:#1e272e;">
    <h2>DAILY GIFT</h2>
    <div style="font-size: 100px; margin: 30px;">üéÅ</div>
    <button class="btn" id="claimBtn" onclick="claimDaily()">CLAIM 200 ü™ô</button>
  </div>

  <div id="game-screen" class="screen">
    <div id="mission-bar">
        <div id="targetTxt" style="color:var(--gold); font-size: 1.2rem;">Target...</div>
        <div style="font-weight: bold;">MOVES: <span id="moveVal">25</span></div>
    </div>
    
    <div id="board-container">
        <div id="board"></div>
    </div>

    <div style="padding-bottom: 30px; text-align: center;">
        <button class="btn" style="background:#ff4757; color:white;" onclick="exitToMap()">EXIT GAME</button>
    </div>
  </div>

  <div id="nav-bar">
    <div class="nav-tab active" id="tab-home" onclick="switchTab('home')">üè†<br>Home</div>
    <div class="nav-tab" id="tab-map" onclick="switchTab('map')">üó∫Ô∏è<br>Map</div>
    <div class="nav-tab" id="tab-daily" onclick="switchTab('daily')">üéÅ<br>Daily</div>
  </div>

  <div id="win-overlay" class="overlay">
    <h1 style="color:#2ed573; font-size:3rem;">WON!</h1>
    <p style="font-size: 1.2rem; margin-bottom: 20px;">+50 Coins Rewarded ü™ô</p>
    <button class="btn" onclick="exitToMap()">CONTINUE</button>
  </div>
  <div id="lose-overlay" class="overlay">
    <h1 style="color:#ff4757; font-size:3rem;">FAILED</h1>
    <button class="btn" onclick="exitToMap()">RETRY</button>
  </div>
</div>

<script>
let aCtx = null;
function unlockAudio() { if(!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)(); }

const SIZE = 8, CELL = 40, CANDIES = ['üçé', 'üçã', 'üçá', 'üíé', 'üç≠', 'üçì'];
let userData = JSON.parse(localStorage.getItem('candy_v10')) || { coins: 0, unlocked: 1, lives: 5, lastDaily: 0 };
let state = { currentLvl: 1, moves: 25, board: [], jelly: [], isLock: false, dragStart: null, type: 'teddy', target: 0, current: 0, hintTimer: null };

function save() { 
    localStorage.setItem('candy_v10', JSON.stringify(userData));
    document.getElementById('coinBal').innerText = userData.coins;
    document.getElementById('lifeVal').innerText = userData.lives;
}

function switchTab(t) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
    document.getElementById(t + '-screen').style.display = 'flex';
    document.getElementById('tab-' + t).classList.add('active');
    if(t === 'map') initMap();
}

function initMap() {
    const path = document.getElementById('levelPath'); path.innerHTML = '';
    for(let i=1; i<=50; i++) {
        const node = document.createElement('div');
        node.style = `width: 60px; height: 60px; background: ${i <= userData.unlocked ? '#6c5ce7' : '#333'}; border: 4px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 5px 15px #000; cursor: pointer; color: white; margin-left: ${Math.sin(i * 0.9) * 85}px;`;
        node.innerHTML = i;
        if(i > userData.unlocked) node.style.opacity = "0.5";
        if(i <= userData.unlocked) node.onclick = () => startLevel(i);
        path.appendChild(node);
    }
}

function startLevel(lvl) {
    state.currentLvl = lvl;
    state.moves = 25 - Math.floor(lvl/10); 
    state.current = 0;
    state.isLock = false;

    const cycle = lvl % 3;
    if(cycle === 1) { state.type = 'teddy'; state.target = 4 + Math.floor(lvl/5); }
    else if(cycle === 2) { state.type = 'score'; state.target = 1000 + (lvl * 250); }
    else { state.type = 'collect'; state.target = 12 + lvl; state.item = CANDIES[lvl % 6]; }

    document.getElementById('nav-bar').style.display = 'none';
    document.getElementById('game-screen').style.display = 'flex';
    createBoard();
    resetHintTimer();
}

function createBoard() {
    const b = document.getElementById('board'); b.innerHTML = '';
    state.board = []; state.jelly = [];
    let tCount = 0;
    for(let r=0; r<SIZE; r++) {
        state.board[r] = []; state.jelly[r] = [];
        for(let c=0; c<SIZE; c++) {
            const j = document.createElement('div');
            j.className = 'jelly-cell';
            if(state.type === 'teddy' && tCount < state.target && Math.random() < 0.15) {
                j.classList.add('has-teddy'); j.innerHTML = 'üß∏'; tCount++;
            }
            j.style.left = c*CELL+'px'; j.style.top = r*CELL+'px';
            b.appendChild(j);
            state.jelly[r][c] = j;
            const candy = makeCandy(r, c);
            state.board[r][c] = candy; b.appendChild(candy);
        }
    }
    if(checkMatches().length > 0) createBoard();
    updateUI();
}

function makeCandy(r, c) {
    const div = document.createElement('div');
    div.className = 'candy'; div.innerHTML = CANDIES[Math.floor(Math.random()*CANDIES.length)];
    div.style.left = c*CELL+'px'; div.style.top = r*CELL+'px';
    return div;
}

function resetHintTimer() {
    clearTimeout(state.hintTimer);
    document.querySelectorAll('.candy').forEach(c => c.classList.remove('hint-active'));
    state.hintTimer = setTimeout(() => {
        const move = findMove();
        if(move) {
            state.board[move.r1][move.c1].classList.add('hint-active');
            state.board[move.r2][move.c2].classList.add('hint-active');
        } else { shuffleBoard(); }
    }, 5000);
}

function findMove() {
    for(let r=0; r<SIZE; r++) for(let c=0; c<SIZE; c++) {
        let n = [[r, c+1], [r+1, c]];
        for(let [nr, nc] of n) {
            if(nr < SIZE && nc < SIZE) {
                [state.board[r][c], state.board[nr][nc]] = [state.board[nr][nc], state.board[r][c]];
                let m = checkMatches();
                [state.board[r][c], state.board[nr][nc]] = [state.board[nr][nc], state.board[r][c]];
                if(m.length > 0) return { r1:r, c1:c, r2:nr, c2:nc };
            }
        }
    }
    return null;
}

async function shuffleBoard() {
    state.isLock = true;
    document.getElementById('board').classList.add('shuffling');
    await new Promise(r => setTimeout(r, 800));
    createBoard();
    document.getElementById('board').classList.remove('shuffling');
    state.isLock = false; resetHintTimer();
}

document.getElementById('board').ontouchstart = (e) => {
    if(state.isLock) return;
    const p = e.touches[0]; const rect = document.getElementById('board').getBoundingClientRect();
    state.dragStart = { x:p.clientX, y:p.clientY, r:Math.floor((p.clientY-rect.top)/CELL), c:Math.floor((p.clientX-rect.left)/CELL) };
};

window.ontouchend = (e) => {
    if(!state.dragStart || state.isLock) return;
    const p = e.changedTouches[0];
    const dx = p.clientX - state.dragStart.x, dy = p.clientY - state.dragStart.y;
    if(Math.abs(dx)>15 || Math.abs(dy)>15) {
        let r2 = state.dragStart.r, c2 = state.dragStart.c;
        if(Math.abs(dx)>Math.abs(dy)) c2 += dx>0?1:-1; else r2 += dy>0?1:-1;
        if(r2>=0 && r2<SIZE && c2>=0 && c2<SIZE) trySwap(state.dragStart.r, state.dragStart.c, r2, c2);
    }
    state.dragStart = null;
};

async function trySwap(r1, c1, r2, c2) {
    state.isLock = true; resetHintTimer();
    let a = state.board[r1][c1], b = state.board[r2][c2];
    a.style.left = c2*CELL+'px'; a.style.top = r2*CELL+'px';
    b.style.left = c1*CELL+'px'; b.style.top = r1*CELL+'px';
    await new Promise(r => setTimeout(r, 200));
    [state.board[r1][c1], state.board[r2][c2]] = [state.board[r2][c2], state.board[r1][c1]];
    let m = checkMatches();
    if(m.length > 0) {
        state.moves--; await processMatches(m);
    } else {
        a.style.left = c1*CELL+'px'; a.style.top = r1*CELL+'px';
        b.style.left = c2*CELL+'px'; b.style.top = r2*CELL+'px';
        [state.board[r1][c1], state.board[r2][c2]] = [state.board[r2][c2], state.board[r1][c1]];
        state.isLock = false;
    }
}

function checkMatches() {
    let matched = new Set();
    for(let r=0; r<SIZE; r++) for(let c=0; c<SIZE-2; c++) {
        if(state.board[r][c] && state.board[r][c+1] && state.board[r][c+2])
        if(state.board[r][c].innerHTML == state.board[r][c+1].innerHTML && state.board[r][c].innerHTML == state.board[r][c+2].innerHTML)
            { matched.add(state.board[r][c]); matched.add(state.board[r][c+1]); matched.add(state.board[r][c+2]); }
    }
    for(let c=0; c<SIZE; c++) for(let r=0; r<SIZE-2; r++) {
        if(state.board[r][c] && state.board[r+1][c] && state.board[r+2][c])
        if(state.board[r][c].innerHTML == state.board[r+1][c].innerHTML && state.board[r][c].innerHTML == state.board[r+2][c].innerHTML)
            { matched.add(state.board[r][c]); matched.add(state.board[r+1][c]); matched.add(state.board[r+2][c]); }
    }
    return Array.from(matched);
}

async function processMatches(m) {
    while(m.length > 0) {
        m.forEach(c => {
            for(let r=0; r<SIZE; r++) for(let col=0; col<SIZE; col++) {
                if(state.board[r][col] === c) {
                    if(state.type === 'teddy' && state.jelly[r][col].classList.contains('has-teddy')) {
                        state.jelly[r][col].classList.remove('has-teddy'); state.jelly[r][col].innerHTML = '';
                    }
                    if(state.type === 'score') state.current += 50;
                    if(state.type === 'collect' && c.innerHTML === state.item) state.current++;
                    state.board[r][col] = null;
                }
            }
            c.style.transform = 'scale(0)';
        });
        await new Promise(r => setTimeout(r, 200));
        m.forEach(c => c.remove());
        await fall(); updateUI();
        await new Promise(r => setTimeout(r, 250));
        m = checkMatches();
    }
    checkStatus();
}

async function fall() {
    for(let c=0; c<SIZE; c++) {
        let empty = 0;
        for(let r=SIZE-1; r>=0; r--) {
            if(!state.board[r][c]) empty++;
            else if(empty > 0) {
                state.board[r+empty][c] = state.board[r][c]; state.board[r][c] = null;
                state.board[r+empty][c].style.top = (r+empty)*CELL+'px';
            }
        }
        for(let i=0; i<empty; i++) {
            let r = empty - 1 - i;
            let candy = makeCandy(r, c); state.board[r][c] = candy; candy.style.top = '-40px';
            document.getElementById('board').appendChild(candy);
            setTimeout(() => candy.style.top = r*CELL+'px', 20);
        }
    }
}

function updateUI() {
    let tTxt = "";
    if(state.type === 'teddy') tTxt = `Rescue: ${document.querySelectorAll('.has-teddy').length} üß∏`;
    else if(state.type === 'score') tTxt = `Score: ${state.current}/${state.target}`;
    else tTxt = `Collect ${state.item}: ${state.current}/${state.target}`;
    
    document.getElementById('targetTxt').innerText = tTxt;
    document.getElementById('moveVal').innerText = state.moves;
}

function checkStatus() {
    let win = false;
    if(state.type === 'teddy' && document.querySelectorAll('.has-teddy').length === 0) win = true;
    else if(state.type === 'score' && state.current >= state.target) win = true;
    else if(state.type === 'collect' && state.current >= state.target) win = true;

    if(win) {
        state.isLock = true;
        userData.coins += 50; // Win reward
        if(state.currentLvl === userData.unlocked) userData.unlocked++;
        save(); document.getElementById('win-overlay').style.display = 'flex';
    } else if(state.moves <= 0) {
        state.isLock = true; userData.lives--; save(); document.getElementById('lose-overlay').style.display = 'flex';
    } else { state.isLock = false; resetHintTimer(); }
}

function exitToMap() {
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('nav-bar').style.display = 'flex';
    document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
    switchTab('map');
}

function claimDaily() {
    if(Date.now() - userData.lastDaily > 86400000) {
        userData.coins += 200; userData.lastDaily = Date.now(); save();
        alert("200 Coins Added!");
    } else { alert("Come back tomorrow!"); }
}

save(); initMap();
</script>
</body>
</html>
